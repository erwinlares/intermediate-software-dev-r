---
title: "More Palmer Penguins"
author: "Erwin Lares"
date: "2023-02-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(googlesheets4)
library(googledrive)
library(lubridate)
library(tictoc)


data <- read_csv("/Volumes/lares/public_data/original_palmerpenguins.csv") |> 
  filter(!is.na(sex))

# options(gargle_oauth_cache = ".secrets", 
#         gargle_oauth_email = "lares@wisc.edu",
#         gargle_oob_default = TRUE)

#library(palmerpenguins)
# prop.table(table(data$island)) # not actually used here, but ...
species_p <- prop.table(xtabs(~island + species, data=data), margin=1)
species_p

# model four measurements, based on species (island is irrelevant here)
bl <- lm(bill_length_mm ~ species, data=data)
bd <- lm(bill_depth_mm ~  species, data=data)
fl <- lm(flipper_length_mm ~ species, data=data)
bm <- lm(body_mass_g ~    species, data=data)

```

## New speciments are captured



The success of Penguin research has been so overwhelmingly positive, that a few years after the initial data collection occurred, a new initiative to capture and tag new penguins was launched. 

This device moves captured specimens into an enclosure. Specimens are measured and tagged and release right away.



# Accessing the instrument's data 

```{r}

tic()
#simulate one penguin
for (i in 1:1000000) {
  newdata <- data.frame(
    island=sample.int(3, size=1) |>   # sample an island
      factor(levels = c("1", "2", "3"), labels = c("Torgersen", "Biscoe", "Dream"))
  )
  
  # generate species based on island
  newdata$species <- sample.int(3, size=1, prob=species_p[newdata$island, ]) |>
    factor(levels=c("1", "2", "3"), labels=(unique(data$species)))
  # generate measurements based on species
  newdata$bl <- predict(bl, newdata) + rnorm(1, sd=sigma(bl))
  newdata$bd <- predict(bd, newdata) + rnorm(1, sd=sigma(bd))
  newdata$fl <- predict(fl, newdata) + rnorm(1, sd=sigma(fl))
  newdata$bm <- predict(bm, newdata) + rnorm(1, sd=sigma(bm))
 
  new_sex <- sample(unique(data$sex),
                    1,
                    replace=TRUE,
                    prob=c(0.4954955, 0.5045045))
new_year <- sample(2009:2023, 1, replace = TRUE) |> as.integer()
new_month <- sample(1:12, 1, replace = TRUE) |> as.integer()
new_day <- sample(1:27, 1, replace = TRUE) |> as.integer()
new_hour <- sample(0:23, 1, replace = TRUE) |> as.integer()

newdata <- newdata |> 
  mutate(species = species,
         island = island, 
         bill_length_mm = bl, 
         bill_depth_mm = bd,
         flipper_length_mm = fl,
         body_mass_g = bm, 
         sex = new_sex,
         year = new_year,
         month = new_month,
         day = new_day,
         hour = new_hour)

  if (i == 1) {
    simdata <- newdata
  } else {
    simdata <- rbind(simdata, newdata)
 


 }
}
toc()

```

```{r}

#creates the new sheet "new-penguin-entry" and an associated R object "test_sheet" that 
#points to that sheet
#googledrive::drive_trash("new-penguin-entry")



#test_sheet <- gs4_create("new-penguin-entry", sheets = new_penguin)
# sheet_append(ss = test_sheet, data = new_penguin)
# drive_deauth()
# drive_auth()
# gs4_auth(token = drive_token())
# test_sheet <- gs4_create("penguin-capture", sheets = new_penguin)

drive_auth(path = "service_account_key.json")
#
gs4_auth(token = drive_token())


sheet_append(ss = "1HEQa23hR202egPcnyAtQHGyPRw1WWv61H6aHnAhjcrc", 
             data = simdata)



# they definitely exist somewhere
#googledrive::drive_find(type = "spreadsheet")


```


```{r, eval=FALSE}

pop_summary <- function(df) {
  df |> 
    summarize(bill_length_mm = mean(bill_length_mm, na.rm = TRUE),
              bill_depth_mm = mean(bill_depth_mm, na.rm = TRUE),
              flipper_length_mm = mean(flipper_length_mm, na.rm = TRUE),
              body_mass_g = mean(body_mass_g),
              .groups = "keep") |> 
    add_column(species = unique(df$species), 
               island = unique(df$island), 
               .before = 1)
}

penguins_summary <- data |>
  group_by(species, island) |> 
  group_split() |> 
  map_dfr(.f = pop_summary)





```

